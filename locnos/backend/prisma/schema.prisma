// Arquivo de schema do Prisma para Supabase (PostgreSQL)
// Gera os modelos de dados e o cliente Prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== USUÁRIOS =====
model User {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informações básicas
  name     String
  email    String   @unique
  password String   // Hash bcrypt
  role     UserRole @default(CUSTOMER)

  // Contato
  phone    String?
  whatsapp String?

  // Documentos (Brasil)
  documentType   DocumentType
  documentNumber String       @unique
  documentVerified Boolean @default(false)

  // Endereço
  addressStreet      String?
  addressNumber      String?
  addressComplement  String?
  addressNeighborhood String?
  addressCity        String?
  addressState       String?
  addressZipCode     String?
  addressCountry     String? @default("Brasil")

  // Empresa (para CNPJ)
  companyName                 String?
  companyTradeName            String?
  companyStateRegistration    String?
  companyMunicipalRegistration String?

  // Status
  status UserStatus @default(PENDING)

  // Permissões (array JSON para flexibilidade)
  permissions String[] @default([])

  // Localização/filial
  locationId String?
  location   Location? @relation(fields: [locationId], references: [id])

  // Dados do cliente
  creditLimit  Decimal  @default(0) @db.Decimal(10, 2)
  totalRented  Int      @default(0)
  totalSpent   Decimal  @default(0) @db.Decimal(10, 2)
  lastRental   DateTime?
  notes        String?
  rating       Int?     @db.SmallInt

  // Avatar
  avatar String?

  // Senha reset
  resetPasswordToken  String?
  resetPasswordExpire DateTime?

  // Último login
  lastLogin DateTime?

  // Relacionamentos
  contracts       Contract[]
  payments        Payment[]
  createdEquipment Equipment[] @relation("CreatedBy")
  updatedEquipment Equipment[] @relation("UpdatedBy")
  createdContracts Contract[] @relation("CreatedBy")
  approvedContracts Contract[] @relation("ApprovedBy")

  @@index([email])
  @@index([documentNumber])
  @@index([role, status])
  @@map("users")
}

enum UserRole {
  CUSTOMER
  STAFF
  ADMIN
  SUPER_ADMIN
}

enum DocumentType {
  CPF
  CNPJ
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  PENDING
}

// ===== CATEGORIAS =====
model Category {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name        String  @unique
  slug        String  @unique
  description String?
  icon        String?
  image       String?

  // Hierarquia
  parentId String?
  parent   Category?   @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[]  @relation("CategoryHierarchy")

  // Ordem de exibição
  order Int @default(0)

  // Status
  active Boolean @default(true)

  // Metadados
  totalEquipment Int @default(0)
  popularityScore Int @default(0)

  // Relacionamentos
  equipment Equipment[]

  @@index([slug])
  @@index([parentId])
  @@index([active, order])
  @@map("categories")
}

// ===== EQUIPAMENTOS =====
model Equipment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Informações básicas
  name        String
  description String

  // Categoria
  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  // Identificação
  serialNumber String? @unique
  barcode      String? @unique
  qrCode       String?
  internalCode String  @unique

  // Especificações (JSON para flexibilidade)
  specifications Json?

  // Imagens (Array JSON)
  images Json?

  // Preços
  dailyRate            Decimal  @db.Decimal(10, 2)
  weeklyRate           Decimal? @db.Decimal(10, 2)
  monthlyRate          Decimal? @db.Decimal(10, 2)
  hourlyRate           Decimal? @db.Decimal(10, 2)
  minimumRentalValue   Int      @default(1)
  minimumRentalUnit    String   @default("day")
  depositRequired      Decimal  @default(0) @db.Decimal(10, 2)
  replacementValue     Decimal? @db.Decimal(10, 2)

  // Status e quantidade
  status            EquipmentStatus @default(AVAILABLE)
  quantityTotal     Int             @default(1)
  quantityAvailable Int             @default(1)
  quantityRented    Int             @default(0)
  quantityReserved  Int             @default(0)
  quantityMaintenance Int           @default(0)

  // Localização
  locationId      String?
  location        Location? @relation(fields: [locationId], references: [id])
  currentLocation String?

  // Aquisição
  acquisitionDate     DateTime?
  acquisitionCost     Decimal?  @db.Decimal(10, 2)
  acquisitionSupplier String?
  warrantyExpiration  DateTime?
  warrantyDescription String?

  // Manutenção
  lastMaintenance        DateTime?
  nextMaintenance        DateTime?
  maintenanceInterval    Int?
  totalMaintenanceCost   Decimal   @default(0) @db.Decimal(10, 2)

  // Estatísticas de uso
  totalRentals     Int      @default(0)
  totalDaysRented  Int      @default(0)
  totalRevenue     Decimal  @default(0) @db.Decimal(10, 2)
  utilizationRate  Decimal  @default(0) @db.Decimal(5, 2)
  lastRentalDate   DateTime?

  // Acessórios (JSON array)
  accessories Json?

  // Instruções
  usageInstructions      String?
  safetyInstructions     String?
  maintenanceInstructions String?
  notes                  String?

  // Visibilidade
  visible  Boolean @default(true)
  featured Boolean @default(false)

  // Tags
  tags String[] @default([])

  // Criador/Editor
  createdById String?
  createdBy   User?   @relation("CreatedBy", fields: [createdById], references: [id])
  updatedById String?
  updatedBy   User?   @relation("UpdatedBy", fields: [updatedById], references: [id])

  // Relacionamentos
  contractItems ContractItem[]
  maintenanceRecords Maintenance[]

  @@index([internalCode])
  @@index([barcode])
  @@index([categoryId, status])
  @@index([status, visible])
  @@map("equipment")
}

enum EquipmentStatus {
  AVAILABLE
  RENTED
  RESERVED
  MAINTENANCE
  RETIRED
}

// ===== CONTRATOS =====
model Contract {
  id             String   @id @default(uuid())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Número do contrato
  contractNumber String @unique

  // Cliente
  customerId String
  customer   User   @relation(fields: [customerId], references: [id])

  // Status
  status ContractStatus @default(QUOTATION)

  // Período de locação
  startDate       DateTime
  endDate         DateTime
  actualStartDate DateTime?
  actualEndDate   DateTime?
  rentalDays      Int?
  extraDays       Int       @default(0)

  // Valores financeiros
  subtotal       Decimal @db.Decimal(10, 2)
  discountAmount Decimal @default(0) @db.Decimal(10, 2)
  discountPercent Decimal @default(0) @db.Decimal(5, 2)
  discountReason String?
  deposit        Decimal @default(0) @db.Decimal(10, 2)
  lateFees       Decimal @default(0) @db.Decimal(10, 2)
  damageFees     Decimal @default(0) @db.Decimal(10, 2)
  total          Decimal @db.Decimal(10, 2)
  totalPaid      Decimal @default(0) @db.Decimal(10, 2)
  balance        Decimal @default(0) @db.Decimal(10, 2)

  // Pagamento
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String?

  // Logística - Entrega
  deliveryRequired       Boolean   @default(false)
  deliveryAddressStreet  String?
  deliveryAddressNumber  String?
  deliveryAddressComplement String?
  deliveryAddressNeighborhood String?
  deliveryAddressCity    String?
  deliveryAddressState   String?
  deliveryAddressZipCode String?
  deliveryScheduledDate  DateTime?
  deliveryCompletedDate  DateTime?
  deliveryCost           Decimal   @default(0) @db.Decimal(10, 2)
  deliveryInstructions   String?
  deliveredById          String?
  deliveryProof          String?

  // Logística - Retirada
  pickupRequired       Boolean   @default(false)
  pickupScheduledDate  DateTime?
  pickupCompletedDate  DateTime?
  pickupCost           Decimal   @default(0) @db.Decimal(10, 2)
  pickedUpById         String?
  pickupProof          String?

  // Documentos (URLs)
  contractDocument  String?
  invoice           String?
  receipt           String?
  deliveryReceipt   String?
  returnReceipt     String?

  // Notas fiscais (JSON array)
  fiscalNotes Json?

  // Termos
  termsAccepted   Boolean   @default(false)
  termsAcceptedAt DateTime?
  termsAcceptedIp String?
  customTerms     String?
  signature       String?

  // Observações
  notes         String?
  internalNotes String?

  // Responsáveis
  createdById  String?
  createdBy    User?     @relation("CreatedBy", fields: [createdById], references: [id])
  approvedById String?
  approvedBy   User?     @relation("ApprovedBy", fields: [approvedById], references: [id])
  approvedAt   DateTime?

  // Renovações
  renewedFromId String?
  renewedFrom   Contract?  @relation("ContractRenewal", fields: [renewedFromId], references: [id])
  renewedTo     Contract[] @relation("ContractRenewal")

  // Relacionamentos
  items    ContractItem[]
  payments Payment[]

  @@index([contractNumber])
  @@index([customerId, status])
  @@index([status, endDate])
  @@index([startDate, endDate])
  @@map("contracts")
}

enum ContractStatus {
  QUOTATION
  PENDING
  APPROVED
  ACTIVE
  COMPLETED
  CANCELLED
  OVERDUE
}

enum PaymentStatus {
  PENDING
  PARTIAL
  PAID
  OVERDUE
  REFUNDED
}

// ===== ITENS DO CONTRATO =====
model ContractItem {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())

  contractId  String
  contract    Contract  @relation(fields: [contractId], references: [id], onDelete: Cascade)
  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id])

  quantity  Int
  unitPrice Decimal @db.Decimal(10, 2)
  subtotal  Decimal @db.Decimal(10, 2)

  // Acessórios (JSON)
  accessories Json?

  // Condição
  condition      String? // 'excellent', 'good', 'fair', ' poor'
  conditionNotes String?

  // Devolução
  returnCondition String?
  returnNotes     String?
  damageCost      Decimal @default(0) @db.Decimal(10, 2)

  @@index([contractId])
  @@index([equipmentId])
  @@map("contract_items")
}

// ===== PAGAMENTOS =====
model Payment {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Contrato e cliente
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])
  customerId String
  customer   User     @relation(fields: [customerId], references: [id])

  // Tipo e método
  type   PaymentType
  method PaymentMethod

  // Valor
  amount Decimal @db.Decimal(10, 2)

  // Status
  status PaymentProcessStatus @default(PENDING)

  // Datas
  dueDate      DateTime?
  paidAt       DateTime?
  cancelledAt  DateTime?
  refundedAt   DateTime?

  // Dados externos (gateway)
  externalPayment Json?

  // Cartão (apenas últimos 4 dígitos)
  cardBrand       String?
  cardLastDigits  String?
  cardHolderName  String?
  cardInstallments Int     @default(1)

  // Comprovante
  receiptUrl    String?
  receiptNumber String?
  receiptDate   DateTime?

  // Nota fiscal
  invoiceNumber String?
  invoiceKey    String?
  invoiceUrl    String?

  // Descrição
  description String?
  notes       String?

  // Processado por
  processedById String?

  // Reembolso
  refundAmount      Decimal?  @db.Decimal(10, 2)
  refundReason      String?
  refundProcessedAt DateTime?
  refundProcessedBy String?

  // Webhook data
  webhookData Json?

  @@index([contractId])
  @@index([customerId])
  @@index([status, dueDate])
  @@map("payments")
}

enum PaymentType {
  DEPOSIT
  RENTAL
  LATE_FEE
  DAMAGE
  ADDITIONAL
  REFUND
}

enum PaymentMethod {
  CASH
  CREDIT_CARD
  DEBIT_CARD
  PIX
  BOLETO
  BANK_TRANSFER
}

enum PaymentProcessStatus {
  PENDING
  PROCESSING
  PAID
  FAILED
  CANCELLED
  REFUNDED
}

// ===== MANUTENÇÃO =====
model Maintenance {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  equipmentId String
  equipment   Equipment @relation(fields: [equipmentId], references: [id])

  type MaintenanceType

  scheduledDate  DateTime?
  completedDate  DateTime?
  cost           Decimal?  @db.Decimal(10, 2)
  description    String?
  technician     String?
  status         String?
  nextMaintenanceDue DateTime?

  @@index([equipmentId])
  @@map("maintenance")
}

enum MaintenanceType {
  PREVENTIVE
  CORRECTIVE
}

// ===== LOCALIZAÇÕES/FILIAIS =====
model Location {
  id        String   @id @default(uuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  name    String  @unique
  code    String? @unique
  address String?
  phone   String?
  active  Boolean @default(true)

  // Relacionamentos
  equipment Equipment[]
  users     User[]

  @@map("locations")
}
